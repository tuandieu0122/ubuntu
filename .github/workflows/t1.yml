name: Nexus CLI (2 nodes, persist state)

on:
  workflow_dispatch:
  schedule:
    # Cháº¡y má»—i 5 giá» Ä‘á»ƒ ká»‹p backup trÆ°á»›c giá»›i háº¡n 6h cá»§a runner
    - cron: "0 */5 * * *"

permissions:
  contents: read
  actions: read

# NgÄƒn trÃ¹ng láº·p nhiá»u run Ä‘Ã¨ nhau (chá»‰ 1 run hoáº¡t Ä‘á»™ng táº¡i 1 thá»i Ä‘iá»ƒm)
concurrency:
  group: nexus-duo-singleton
  cancel-in-progress: false

env:
  # ğŸ‘‰ DÃN 2 NODE ID Cá»¦A Báº N VÃ€O ÄÃ‚Y
  NODE_ID_1: "36063227"
  NODE_ID_2: "36052788"
  # CÃ³ thá»ƒ chá»‰nh difficulty cho nháº¹ mÃ¡y runner cá»§a GitHub (2 vCPU/7GB RAM)
  MAX_DIFFICULTY: "small_medium"
  # Thá»i lÆ°á»£ng cháº¡y trÆ°á»›c khi dá»«ng Ä‘á»ƒ backup (giÃ¢y) ~ 5h30m
  RUN_FOR_SECONDS: "19800"
  # TÃªn file workflow nÃ y (Ä‘á»ƒ bÆ°á»›c download artifact biáº¿t tÃ¬m Ä‘Ãºng workflow).
  # Náº¿u báº¡n Ä‘á»•i tÃªn file, nhá»› Ä‘á»•i biáº¿n nÃ y cho khá»›p.
  WORKFLOW_FILE_NAME: "t1.yml"

jobs:
  nexus:
    runs-on: ubuntu-latest
    # 355 phÃºt < 6h Ä‘á»ƒ cháº¯c cháº¯n job khÃ´ng bá»‹ kill trÆ°á»›c khi upload artifact
    timeout-minutes: 355

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Táº£i state cÅ© (náº¿u cÃ³) tá»« artifact cá»§a cÃ¡c láº§n cháº¡y trÆ°á»›c
      - name: Download previous state artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ${{ env.WORKFLOW_FILE_NAME }}
          name: nexus-state
          if_no_artifact_found: ignore

      - name: Restore state
        run: |
          set -euxo pipefail
          if [ -f nexus-state.tar.zst ]; then
            tar --zstd -xf nexus-state.tar.zst -C "$HOME"
          fi
          mkdir -p "$HOME/.nexus"

      # 2) CÃ i Nexus CLI (non-interactive)
      #    Theo hÆ°á»›ng dáº«n Quick Install / Non-Interactive tá»« docs/README cá»§a Nexus
      - name: Install Nexus CLI
        run: |
          set -euxo pipefail
          curl -sSf https://cli.nexus.xyz/ -o install.sh
          chmod +x install.sh
          NONINTERACTIVE=1 ./install.sh
          nexus-cli --version || true

      # 3) Kiá»ƒm tra Ä‘Ã£ dÃ¡n Node ID chÆ°a
      - name: Validate Node IDs
        run: |
          set -euxo pipefail
          if [ "${NODE_ID_1}" = "PASTE_ID_1" ] || [ -z "${NODE_ID_1}" ]; then
            echo "âŒ Báº¡n chÆ°a dÃ¡n NODE_ID_1 vÃ o env."; exit 1; fi
          if [ "${NODE_ID_2}" = "PASTE_ID_2" ] || [ -z "${NODE_ID_2}" ]; then
            echo "âŒ Báº¡n chÆ°a dÃ¡n NODE_ID_2 vÃ o env."; exit 1; fi

      # 4) CÃ i cÃ´ng cá»¥ há»— trá»£ (tmux, taskset)
      - name: Install helpers (tmux, util-linux)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y tmux util-linux psmisc

      # 5) Khá»Ÿi Ä‘á»™ng 2 node trong 2 phiÃªn tmux riÃªng
      #    Máº¹o: ghi config.json cho NODE_ID_1 -> start node1
      #         sau Ä‘Ã³ ghi láº¡i config.json cho NODE_ID_2 -> start node2
      #    Cáº£ 2 tiáº¿n trÃ¬nh sáº½ giá»¯ node_id Ä‘Ã£ Ä‘á»c khi khá»Ÿi Ä‘á»™ng
      - name: Start 2 Nexus nodes (tmux)
        env:
          N1: ${{ env.NODE_ID_1 }}
          N2: ${{ env.NODE_ID_2 }}
          MAXDIFF: ${{ env.MAX_DIFFICULTY }}
        run: |
          set -euxo pipefail

          tmux -V

          # Node 1
          printf '{\n  "node_id": "%s"\n}\n' "$N1" > "$HOME/.nexus/config.json"
          tmux new -s nexus1 -d "taskset -c 0 nexus-cli start --headless --max-difficulty ${MAXDIFF} --node-id ${N1}"

          # Node 2
          sleep 3
          printf '{\n  "node_id": "%s"\n}\n' "$N2" > "$HOME/.nexus/config.json"
          tmux new -s nexus2 -d "taskset -c 1 nexus-cli start --headless --max-difficulty ${MAXDIFF} --node-id ${N2}"

          # Hiá»ƒn thá»‹ danh sÃ¡ch session Ä‘á»ƒ log
          tmux ls || true

      # 6) Äá»£i ~5h30m rá»“i dá»«ng Ä‘á»ƒ backup state (an toÃ n trÆ°á»›c má»‘c 6h)
      - name: Keep running then stop for backup
        env:
          RUN_FOR_SECONDS: ${{ env.RUN_FOR_SECONDS }}
        run: |
          set -eux
          end=$((SECONDS + RUN_FOR_SECONDS))
          while [ $SECONDS -lt $end ]; do
            tmux has-session -t nexus1 2>/dev/null || break
            tmux has-session -t nexus2 2>/dev/null || break
            sleep 60
          done

          # Táº¯t nháº¹ nhÃ ng
          tmux kill-session -t nexus1 || true
          tmux kill-session -t nexus2 || true
          pkill -f 'nexus-cli start' || true
          sleep 2

      # 7) LÆ°u log ngáº¯n gá»n (tuá»³ chá»n) Ä‘á»ƒ báº¡n xem cho dá»…
      - name: Save last logs
        run: |
          set -eux
          # Thu log náº¿u cÃ²n pane (khÃ´ng báº¯t buá»™c)
          tmux capture-pane -pt nexus1 2>/dev/null | tail -n 200 > nexus1.log || true
          tmux capture-pane -pt nexus2 2>/dev/null | tail -n 200 > nexus2.log || true

      - name: Upload run logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: |
            nexus1.log
            nexus2.log
          retention-days: 7

      # 8) ÄÃ³ng gÃ³i state Ä‘á»ƒ láº§n sau táº£i láº¡i cháº¡y tiáº¿p vá»›i cÃ¹ng 2 ID
      - name: Pack state
        run: |
          set -euxo pipefail
          # LÆ°u toÃ n bá»™ ~/.nexus (bao gá»“m config/credentials) Ä‘á»ƒ láº§n sau tá»± cháº¡y láº¡i
          tar --zstd -cf nexus-state.tar.zst -C "$HOME" .nexus || true
          ls -lah nexus-state.tar.zst || true

      - name: Upload state artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-state
          path: nexus-state.tar.zst
          retention-days: 14
